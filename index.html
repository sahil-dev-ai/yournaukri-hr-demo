<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YourNaukri App - Job Portal</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f7f9fb;
    }

    .app-container {
      max-width: 600px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    }

    .job-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .job-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
    }

    .tag {
      border: 1px solid #d1d5db;
      color: #4b5563;
    }

    .spin {
      width: 3.5rem;
      height: 3.5rem;
      border: 4px solid rgba(255, 255, 255, 0.25);
      border-top-color: #3b82f6;
      border-radius: 9999px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "primary-blue": "#1E40AF",
            "light-blue": "#3B82F6",
            "background-gray": "#f7f9fb",
          },
        },
      },
    };
  </script>
</head>

<body class="min-h-screen flex items-start justify-center p-4 bg-background-gray">

  <div class="app-container w-full bg-white rounded-xl overflow-hidden mt-8">

    <!-- Header -->
    <header class="p-4 border-b flex justify-between items-center sticky top-0 bg-white">
      <h1 class="text-xl font-bold">YourNaukri App</h1>
      <div class="flex gap-4 text-sm">
        <button id="manage-privacy-link" onclick="handleManagePrivacy()">
          Manage Privacy
        </button>
        <span class="font-semibold">Welcome, Kiran</span>
      </div>
    </header>

    <main id="content-view" class="p-6"></main>

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
      <div class="spin"></div>
    </div>
  </div>

  <script>
    const CONSENT_REGISTER_URL =
      "https://consent-token-fetch.netlify.app/.netlify/functions/consent-register";

    const TOKEN_URL =
      "https://consent-token-fetch.netlify.app/.netlify/functions/getToken";

    const CONSENT_PROFILE_ID = "6a3652e6-9604-4458-967f-22c9b2bdf304";

    let selectedJob = {};
    let consentByJob = {};
    let principalId = null;

    const MOCK_JOBS = [
      { id: 1, title: "Front-End Engineer", location: "Delhi", salary: "5-6LPA", type: "Full Time", description: "Frontend role" },
      { id: 2, title: "Graphic Designer", location: "Delhi", salary: "5-6LPA", type: "Full Time", description: "Design role" },
      { id: 3, title: "UX Specialist", location: "Remote", salary: "7-10LPA", type: "Part Time", description: "UX role" },
    ];

    function showLoader(v = true) {
      document.getElementById("loader").style.display = v ? "flex" : "none";
    }

    async function loadCollectorSdkOnce() {
      if (window.LeegalityConsentCollector) return;
      await new Promise((r) => {
        const s = document.createElement("script");
        s.src = "https://sdk.consent.in/consent-collect-sdk.min.js";
        s.onload = r;
        document.body.appendChild(s);
      });
    }

    async function handleConsent() {
      showLoader(true);

      const res = await fetch(CONSENT_REGISTER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: "Kiran Kumar",
          email: "kirankumar@email.com",
          phone: "981271839123",
          consentProfileId: CONSENT_PROFILE_ID,
          consentProfileVersion: 1,
        }),
      });

      const data = await res.json();
      const url = data?.consentUrl;
      const cpid = data?.cpid || null;

      if (cpid) principalId = cpid;

      if (!url) {
        consentByJob[selectedJob.id] = { given: true };
        showLoader(false);
        renderApplicationForm(2);
        return;
      }

      await loadCollectorSdkOnce();
      const collector = new window.LeegalityConsentCollector({ url });

      collector.on("response", () => {
        consentByJob[selectedJob.id] = { given: true };
        showLoader(false);
        renderApplicationForm(2);
      });

      collector.open();
    }

    async function handleManagePrivacy() {
      showLoader(true);
      const token = await fetch(TOKEN_URL).then(r => r.json()).then(j => j.access_token);

      const res = await fetch(
        "https://sandbox-gateway.leegality.com/consent-runner/api/v1/consents/client/update",
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            principalId,
            preferenceUrlType: "PRIVACY",
            publicUrlExpiry: 60,
            sessionExpiry: 60,
          }),
        }
      );

      const j = await res.json();
      const url = j?.data?.privacyCenterUrl;

      await loadCollectorSdkOnce();
      new window.LeegalityConsentCollector({ url }).open();
      showLoader(false);
    }

    function renderJobList() {
      document.getElementById("content-view").innerHTML = MOCK_JOBS.map(
        j => `
        <div class="border p-4 rounded mb-4">
          <h3 class="font-bold">${j.title}</h3>
          <button onclick="viewJobDetail(${j.id})" class="mt-2 text-blue-600">
            See Job
          </button>
        </div>`
      ).join("");
    }

    function viewJobDetail(id) {
      selectedJob = MOCK_JOBS.find(j => j.id === id);
      renderApplicationForm(1);
    }

    function renderApplicationForm(step) {
      if (step === 1) {
        document.getElementById("content-view").innerHTML = `
          <h2 class="text-xl mb-4">Apply for ${selectedJob.title}</h2>
          <button onclick="renderApplicationForm(2)" class="bg-blue-600 text-white px-4 py-2 rounded">
            Continue
          </button>
        `;
      } else {
        document.getElementById("content-view").innerHTML = `
          <button onclick="handleConsent()" class="bg-blue-600 text-white px-4 py-2 rounded mb-4">
            Review & Give Consent
          </button>

          <button onclick="submitApplication()" class="bg-green-600 text-white px-4 py-2 rounded">
            Submit Application
          </button>
        `;
      }
    }

    function submitApplication() {
      renderConfirmation();
    }

    function renderConfirmation() {
      document.getElementById("content-view").innerHTML = `
        <h2 class="text-2xl font-bold text-green-600">
          Application Submitted ðŸŽ‰
        </h2>
        <button onclick="renderJobList()" class="mt-4 underline">
          Back to Jobs
        </button>
      `;
    }

    document.addEventListener("DOMContentLoaded", renderJobList);
  </script>

</body>
</html>
